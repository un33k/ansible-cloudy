# PgBouncer Configuration File
# Generated by Ansible for {{ inventory_hostname }}
# Deployment: Web server (local connection pooling)

#==============================================================================
# DATABASE CONFIGURATION
#==============================================================================
[databases]
# Format: dbname = host=x port=y dbname=z
{{ pgbouncer_db_name }} = host={{ pgbouncer_db_host }} port={{ pgbouncer_db_port }} dbname={{ pgbouncer_db_name }}

# Add additional databases as needed
{% if pgbouncer_additional_databases is defined %}
{% for db in pgbouncer_additional_databases %}
{{ db.name }} = host={{ db.host | default(pgbouncer_db_host) }} port={{ db.port | default(pgbouncer_db_port) }} dbname={{ db.dbname | default(db.name) }}
{% endfor %}
{% endif %}

#==============================================================================
# PGBOUNCER CONFIGURATION
#==============================================================================
[pgbouncer]

#------------------------------------------------------------------------------
# Connection settings
#------------------------------------------------------------------------------
# Where to listen for connections
listen_addr = {{ pgbouncer_listen_addr }}
listen_port = {{ pgbouncer_listen_port }}

# Unix socket settings
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777

#------------------------------------------------------------------------------
# Authentication settings
#------------------------------------------------------------------------------
auth_type = {{ pgbouncer_auth_type | default('md5') }}
auth_file = /etc/pgbouncer/userlist.txt

#------------------------------------------------------------------------------
# Pool settings
#------------------------------------------------------------------------------
# Pool mode: session, transaction, statement
pool_mode = {{ pgbouncer_pool_mode | default('transaction') }}

# Maximum number of client connections allowed
max_client_conn = {{ pgbouncer_max_client_conn }}

# Default pool size per user/database pair
default_pool_size = {{ pgbouncer_default_pool_size }}

# Minimum pool size (0 disables)
min_pool_size = {{ pgbouncer_min_pool_size | default(0) }}

# Reserve pool for super users
reserve_pool_size = {{ pgbouncer_reserve_pool_size | default(5) }}
reserve_pool_timeout = {{ pgbouncer_reserve_pool_timeout | default(3) }}

# Maximum number of connections per database
max_db_connections = {{ pgbouncer_max_db_connections }}

# Maximum number of connections per user
max_user_connections = {{ pgbouncer_max_user_connections | default(0) }}

#------------------------------------------------------------------------------
# Timeouts
#------------------------------------------------------------------------------
# Queries running longer than this are canceled
query_timeout = {{ pgbouncer_query_timeout | default(0) }}

# Time to wait for query completion before canceling
query_wait_timeout = {{ pgbouncer_query_wait_timeout | default(60) }}

# Close server connections that have been idle longer than this
server_idle_timeout = {{ pgbouncer_server_idle_timeout | default(600) }}

# Close client connections that have been idle longer than this
client_idle_timeout = {{ pgbouncer_client_idle_timeout | default(0) }}

# How long to wait for server connect
server_connect_timeout = {{ pgbouncer_server_connect_timeout | default(15) }}

# How long to wait for client connect
client_login_timeout = {{ pgbouncer_client_login_timeout | default(60) }}

# Cancel query on server after getting Cancel from client
server_reset_query_always = {{ pgbouncer_server_reset_query_always | default(0) }}

#------------------------------------------------------------------------------
# Low-level network settings
#------------------------------------------------------------------------------
# DNS lookup cache time
dns_max_ttl = {{ pgbouncer_dns_max_ttl | default(15) }}

# DNS zone SOA lookup period
dns_nxdomain_ttl = {{ pgbouncer_dns_nxdomain_ttl | default(15) }}

# Custom resolv.conf file
# dns_resolv_conf = /etc/pgbouncer/resolv.conf

#------------------------------------------------------------------------------
# Logging
#------------------------------------------------------------------------------
# Log settings
logfile = {{ pgbouncer_logfile | default('/var/log/pgbouncer/pgbouncer.log') }}
pidfile = {{ pgbouncer_pidfile | default('/var/run/pgbouncer/pgbouncer.pid') }}

# Log verbosity
log_connections = {{ pgbouncer_log_connections | default(1) }}
log_disconnections = {{ pgbouncer_log_disconnections | default(1) }}
log_pooler_errors = {{ pgbouncer_log_pooler_errors | default(1) }}
log_stats = {{ pgbouncer_log_stats | default(1) }}

# Period for writing aggregated stats to log
stats_period = {{ pgbouncer_stats_period | default(60) }}

#------------------------------------------------------------------------------
# Console access control
#------------------------------------------------------------------------------
# Admin users can use all commands on console
admin_users = {{ pgbouncer_admin_users | default('postgres') }}

# Stats users can use SHOW commands except SHOW FDS
stats_users = {{ pgbouncer_stats_users | default('postgres, pgbouncer') }}

#------------------------------------------------------------------------------
# Connection sanity checks
#------------------------------------------------------------------------------
# Reject clients with server_reset_query_always = 0
server_reset_query_always = {{ pgbouncer_server_reset_query_always | default(0) }}

# Whether to ignore parameter changes by client
ignore_startup_parameters = {{ pgbouncer_ignore_startup_parameters | default('extra_float_digits') }}

# Disable prepared statements protocol
disable_pqexec = {{ pgbouncer_disable_pqexec | default(0) }}

# Application name to add to server
application_name_add_host = {{ pgbouncer_application_name_add_host | default(0) }}

# Maximum packet size
max_packet_size = {{ pgbouncer_max_packet_size | default(2147483647) }}

# Listen backlog
listen_backlog = {{ pgbouncer_listen_backlog | default(128) }}

# TCP keepalive
tcp_keepalive = {{ pgbouncer_tcp_keepalive | default(1) }}
tcp_keepcnt = {{ pgbouncer_tcp_keepcnt | default(0) }}
tcp_keepidle = {{ pgbouncer_tcp_keepidle | default(0) }}
tcp_keepintvl = {{ pgbouncer_tcp_keepintvl | default(0) }}

# TCP user timeout (Linux 2.6.37+)
tcp_user_timeout = {{ pgbouncer_tcp_user_timeout | default(0) }}