# PgPool-II Configuration File
# Generated by Ansible for {{ inventory_hostname }}
# Based on python-cloudy best practices

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------

# - pgpool Connection Settings -
listen_addresses = '{{ pgpool_listen_address | default("localhost") }}'
port = {{ pgpool_listen_port }}
socket_dir = '{{ pgpool_socket_dir }}'
listen_backlog_multiplier = 2
serialize_accept = off

# - pgpool Communication Manager Connection Settings -
pcp_listen_addresses = 'localhost'
pcp_port = 9898
pcp_socket_dir = '{{ pgpool_socket_dir }}'

# - Backend Connection Settings -
backend_hostname0 = '{{ pgpool_backend_host }}'
backend_port0 = {{ pgpool_backend_port }}
backend_weight0 = 1
backend_data_directory0 = '/var/lib/postgresql/{{ pg_version | default("15") }}/main'
backend_flag0 = 'ALLOW_TO_FAILOVER'

#------------------------------------------------------------------------------
# POOLS
#------------------------------------------------------------------------------

# - Pool size -
num_init_children = {{ pgpool_num_init_children }}
max_pool = {{ pgpool_max_pool }}

# - Life time -
child_life_time = {{ pgpool_child_life_time | default(300) }}
child_max_connections = {{ pgpool_child_max_connections | default(0) }}
connection_life_time = {{ pgpool_connection_life_time | default(0) }}
client_idle_limit = {{ pgpool_client_idle_limit | default(0) }}

#------------------------------------------------------------------------------
# LOGS
#------------------------------------------------------------------------------

# - Where to log -
log_destination = 'syslog'
syslog_facility = 'LOCAL0'
syslog_ident = 'pgpool'

# - What to log -
log_connections = {{ pgpool_log_connections | default('off') }}
log_hostname = {{ pgpool_log_hostname | default('off') }}
log_statement = {{ pgpool_log_statement | default('off') }}
log_per_node_statement = {{ pgpool_log_per_node_statement | default('off') }}
log_client_messages = {{ pgpool_log_client_messages | default('off') }}
log_standby_delay = 'if_over_threshold'

# - Syslog specific -
log_line_prefix = '%t: pid %p: '

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

pid_file_name = '/var/run/pgpool/pgpool.pid'
logdir = '/var/log/pgpool'

#------------------------------------------------------------------------------
# CONNECTION POOLING
#------------------------------------------------------------------------------

connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'

#------------------------------------------------------------------------------
# REPLICATION MODE
#------------------------------------------------------------------------------

replication_mode = off
replicate_select = off
insert_lock = off
lobj_lock_table = ''

#------------------------------------------------------------------------------
# LOAD BALANCING MODE
#------------------------------------------------------------------------------

load_balance_mode = {{ pgpool_load_balance_mode | default('off') }}
ignore_leading_white_space = on
white_function_list = ''
black_function_list = 'currval,lastval,nextval,setval'
black_query_pattern_list = ''
database_redirect_preference_list = ''
app_name_redirect_preference_list = ''
allow_sql_comments = off
disable_load_balance_on_write = 'transaction'
statement_level_load_balance = off

#------------------------------------------------------------------------------
# MASTER/SLAVE MODE
#------------------------------------------------------------------------------

master_slave_mode = off
master_slave_sub_mode = 'stream'

#------------------------------------------------------------------------------
# HEALTH CHECK GLOBAL PARAMETERS
#------------------------------------------------------------------------------

health_check_period = {{ pgpool_health_check_period | default(0) }}
health_check_timeout = {{ pgpool_health_check_timeout | default(20) }}
health_check_user = '{{ pgpool_health_check_user | default("nobody") }}'
health_check_password = ''
health_check_database = ''
health_check_max_retries = 0
health_check_retry_delay = 1
connect_timeout = 10000

#------------------------------------------------------------------------------
# FAILOVER AND FAILBACK
#------------------------------------------------------------------------------

failover_on_backend_error = off
failover_on_backend_shutdown = off
detach_false_primary = off

#------------------------------------------------------------------------------
# ONLINE RECOVERY
#------------------------------------------------------------------------------

recovery_user = '{{ pgpool_recovery_user | default("nobody") }}'
recovery_password = ''
recovery_1st_stage_command = ''
recovery_2nd_stage_command = ''
recovery_timeout = 90

#------------------------------------------------------------------------------
# WATCHDOG
#------------------------------------------------------------------------------

use_watchdog = off

#------------------------------------------------------------------------------
# MISCELLANEOUS
#------------------------------------------------------------------------------

relcache_expire = 0
relcache_size = 256
check_temp_table = catalog
check_unlogged_table = on
memory_cache_enabled = off
enable_shared_relcache = on
relcache_query_target = primary