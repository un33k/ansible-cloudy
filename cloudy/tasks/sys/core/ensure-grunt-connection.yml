# Ensure Grunt Connection - Connection Validation Task
# Validates that the current connection is using grunt user with SSH keys
# This task should be included in all service recipes to ensure proper authentication

---
- name: Validate connection user
  debug:
    msg: |
      ğŸ” Connection Validation:
      Current user: {{ ansible_user }}
      Current port: {{ ansible_port }}
      Target: {{ ansible_host }}:{{ ansible_port }}

- name: Fail if connecting as root user
  fail:
    msg: |
      âŒ SECURITY ERROR: Connected as root user!
      
      This recipe requires grunt user connection with SSH keys.
      
      Root access should only be used for initial security setup.
      
      Expected: ansible_user should be 'grunt' or '{{ grunt_user | default("grunt") }}'
      Actual: ansible_user is '{{ ansible_user }}'
      
      ğŸ”§ Fix:
      1. Run security setup first: ./claudia security --install
      2. Ensure you're targeting 'service_targets' group, not 'security_targets'
  when: ansible_user == 'root'

- name: Fail if using password authentication
  fail:
    msg: |
      âŒ AUTHENTICATION ERROR: Password authentication detected!
      
      This recipe requires SSH key authentication only.
      
      Grunt passwords should only be used for account creation and sudo.
      
      ğŸ”§ Fix:
      1. Remove ansible_ssh_pass from inventory
      2. Ensure SSH keys are installed: ./claudia security --install
      3. Use SSH key authentication only
  when: ansible_ssh_pass is defined

- name: Fail if using default SSH port
  fail:
    msg: |
      âŒ PORT ERROR: Using default SSH port 22!
      
      This recipe should connect to the secure SSH port.
      
      Expected: ansible_port should be 22022 (or custom secure port)
      Actual: ansible_port is {{ ansible_port }}
      
      ğŸ”§ Fix:
      1. Run security setup first: ./claudia security --install
      2. Ensure inventory uses the secure SSH port (22022)
  when: ansible_port == 22

- name: Validate grunt user
  command: whoami
  register: current_user
  changed_when: false
  become: false

- name: Fail if not connecting as expected grunt user
  fail:
    msg: |
      âŒ USER ERROR: Not connecting as expected grunt user!
      
      Expected: {{ grunt_user | default('grunt') }}
      Actual: {{ current_user.stdout }}
      
      ğŸ”§ Fix:
      1. Verify admin user exists on server
      2. Check SSH key permissions
      3. Run security setup: ./claudia security --install
  when: current_user.stdout != (grunt_user | default('grunt'))

- name: Test SSH key authentication
  stat:
    path: ~/.ssh/authorized_keys
  register: ssh_keys
  become: false

- name: Fail if SSH keys not properly configured
  fail:
    msg: |
      âŒ SSH KEY ERROR: SSH keys not properly configured!
      
      The authorized_keys file is missing or empty.
      
      ğŸ”§ Fix:
      1. Run security setup: ./claudia security --install
      2. Verify SSH key installation completed successfully
  when: not ssh_keys.stat.exists

- name: Test sudo access (NOPASSWD)
  command: sudo -n whoami
  register: sudo_test
  changed_when: false
  failed_when: false
  become: false

- name: Fail if sudo access not working
  fail:
    msg: |
      âŒ SUDO ERROR: Grunt user cannot sudo without password!
      
      Expected: NOPASSWD sudo access for grunt user
      Actual: sudo requires password or fails
      
      ğŸ”§ Fix:
      1. Run security setup: ./claudia security --install
      2. Verify sudoers configuration is correct
  when: sudo_test.rc != 0 or sudo_test.stdout != 'root'

- name: Display connection validation success
  debug:
    msg: |
      âœ… CONNECTION VALIDATION PASSED
      
      ğŸ” Authentication Status: SECURE
      â”œâ”€â”€ User: {{ current_user.stdout }} (grunt)
      â”œâ”€â”€ Port: {{ ansible_port }} (secure)
      â”œâ”€â”€ Auth: SSH keys only
      â”œâ”€â”€ Sudo: NOPASSWD access
      â””â”€â”€ Ready for service operations
      
      ğŸš€ Proceeding with recipe execution...